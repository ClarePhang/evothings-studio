<!DOCTYPE html>
<html>
<!--
File: hyper-ui.html
Description: Main application file. Defines the UI and starts the server.
Author: Mikael Kindborg
Copyright (c) 2013-2015 Evothings AB
-->
<!-- HTML 5 differences from HTML 4: http://www.w3.org/TR/2008/WD-html5-diff-20080122/ -->
<head>
	<meta charset="utf-8">
	<link href="../libs/bootstrap-3.3.5-dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="../libs/jquery/jquery-2.1.4.min.js"></script>
	<script src="../libs/jquery/jquery-ui.min.js"></script>
	<script src="../libs/bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
	<link href="hyper-common.css" rel="stylesheet" />
	<link href="hyper-ui.css" rel="stylesheet" />
</head>
<body>
	<div id="panel-page">

		<div id="panel-top">

			<div id="panel-tool-menu">
				<div class="btn-group btn-group-justified">
					<button id="button-tool-menu" class="btn btn-primary dropdown-toggle btn-hyper-toolbar et-btn-charcoal"
						data-toggle="dropdown">
						<span class="glyphicon glyphicon-align-justify"></span>
					</button>
					<ul class="dropdown-menu">
						<li><a href="javascript:void(0)" onclick="window.showSettingsDialog()">Settings</a></li>
						<li><a href="javascript:void(0)"
							onclick="hyper.showWelcomeScreen()">Welcome Screen</a></li>
					</ul>
				</div>
			</div>

			<div id="panel-tool-buttons">
				<div class="btn-group btn-group-justified" role="group">
                    <a id="button-connect"
                       class="btn btn-hyper-toolbar et-btn-stone-light"
                       href="javascript:void(0)">Connect</a>
					<a id="button-examples"
						class="btn btn-hyper-toolbar et-btn-stone-light"
						href="javascript:void(0)">Examples</a>
					<a id="button-projects"
						class="btn btn-hyper-toolbar et-btn-stone-light"
						href="javascript:void(0)">Projects</a>
					<a id="button-tools"
						class="btn btn-hyper-toolbar btn-toolbar et-btn-white"
						href="javascript:void(0)" style="border-left">Tools</a>
					<a id="button-documentation"
						class="btn btn-hyper-toolbar btn-toolbar et-btn-white"
						href="javascript:void(0)">Docs</a>
					<a id="button-forum"
						class="btn btn-hyper-toolbar btn-toolbar et-btn-white"
						href="javascript:void(0)">Forum</a>
				</div>
			</div>

		</div>

		<div id="panel-middle">
			<!-- ModalDialog-NoClientConnected--->
			<div class="modal fade" id="ModalDialog-NoClientConnected" tabindex="-1" role="dialog" aria-labelledby="ModalDialog-NoClientConnected-Label" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
							<h4 class="modal-title" id="ModalDialog-NoClientConnected-Label">No client connected</h4>
						</div>
						<div class="modal-body">
							Please connect from the <a href="javascript:void(0)" id="ModalDialog-NoClientConnected-ClientAppLink">Evothings Viewer</a> app.
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>

			<!-- ModalDialog-NewVersionAvailable--->
			<div class="modal fade" id="ModalDialog-NewVersionAvailable" tabindex="-1" role="dialog" aria-labelledby="ModalDialog-NewVersionAvailable-Label" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
							<h4 class="modal-title" id="ModalDialog-NewVersionAvailable-Label">New Version Available!</h4>
						</div>
						<div class="modal-body">
							<p>New version <span id="ModalDialog-NewVersionAvailable-VersionNumber"></span>
							of Evothings Studio is available! Get it at the
							<a href="javascript:void(0)" id="ModalDialog-NewVersionAvailable-DownloadLink">download page</a>.</p>
							<div class="checkbox">
								<input id="ModalDialog-NewVersionAvailable-DoNotShowCheckbox" type="checkbox"> Do not show again for this version.
							</div>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal dialog: dialog-settings -->
			<div class="modal fade"
				id="dialog-settings"
				tabindex="-1"
				role="dialog"
				aria-labelledby="dialog-settings-label"
				aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
							<h4 class="modal-title" id="dialog-settings-label">
								Settings Dialog
							</h4>
						</div>

						<div class="modal-body">
							<div class="form-group">
								<label for="input-setting-javascript-workbench-font-size">
									JavaScript Workbench font size:</label>
								<input type="text"
									id="input-setting-javascript-workbench-font-size"
									class="form-control"
									placeholder="18px"/>
							</div>
							<div class="form-group">
								<label for="input-setting-number-of-directory-levels">
									Number of directory levels to monitor for live reload:</label>
								<input type="text"
									id="input-setting-number-of-directory-levels"
									class="form-control"
									placeholder="3"/>
							</div>
							<div class="form-group">
								<label for="input-setting-reload-server-address">
									Address of Reload Server:</label>
								<input type="text"
									id="input-setting-reload-server-address"
									class="form-control"
									placeholder=""/>
							</div>
						</div>

						<div class="modal-footer">
								<button type="button"
									class="btn btn-success"
									onclick="hyper.UI.saveSettings()">
									Save
								</button>
							<button type="button"
								class="btn btn-default"
								data-dismiss="modal">
								Dismiss
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Connect screen -->
			<div id="screen-connect">
				<div class="panel">
					<div class="panel-body">

						<h2>Connect</h2>

						<p>To connect to the Workbench from the Evothings Viewer mobile app, you need Internet access and a connect key.</p>

						<p>Click the "Get Key" button to obtain a connect key. Use this key when connecting from the Evothings Viewer app. Click "Get Key" again if the key has timed out. Once connected, your session has no time limit.</p>

						<div class="well">
							<span id="connect-key">Click GET KEY</span>
						</div>

						<div>
							<button type="button"
								class="btn et-btn-green"
								onclick="hyper.UI.getConnectKeyFromServer()">
								Get Key <span id="connect-spinner" class="glyphicon glyphicon-refresh glyphicon-spin"></span>
							</button>
						</div>

						<div>
							<p id="connect-screen-message"></p>
						</div>

						<div >
							<button id="button-login"
								type="button"
								class="btn et-btn-blue">
								Login
							</button>
						</div>

						<div id="connect-screen-login">
							<iframe id="connect-screen-login-iframe"
								src="" nwdisable nwfaketop>
							</iframe>
						</div>

					</div>
				</div>
			</div>

			<!-- Example list -->
			<div id="screen-examples" class="project-list"></div>

			<!-- Project list -->
			<div id="screen-projects" class="project-list"></div>

		</div>

		<div id="panel-bottom">
			<div>
				<p style="float:left;">Status: <b><span id="connect-address">Waiting to connect</span></b></p>
                <p style="float:left;margin-left:25px"><b><span id="login-info">Not Logged In</span></b></p>
				<p style="float:right;">Clients: <b><span id="connect-counter">0</span></b> Files: <b><span id="files-counter">0</span></b></p>
			</div>
		</div>

		<div id="drag-overlay">
			<div class="ui-corner-all">
				<h1>Drop HTML file here</h1>
				<h4>Drop the main HTML file of your project here to
				add it to the project list. You can rearrange the list
				by drag and drop of items.</h4>
			</div>
		</div>

	</div> <!-- panel-page -->

	<!--
	hyper-ui.js defines the global variable "hyper".
	TODO: Change this to a module and import using require.
	-->
	<script src="hyper-ui.js"></script>
	<script>
	//
	// TODO:
	//
	// The plan is to move more of the logic into hyper-ui.js and possibly
	// create additional module files to make the code easier to read.
	//
	// Also import hyper-ui.js using "require". The idea is to make
	// the code more modular.
	//

	// Setup UI button actions (using closure to make variables local).
	;(function()
	{
		var PATH = require('path')
		var GUI = require('nw.gui')
		var FILEUTIL = require('../server/fileutil.js')
		var SETTINGS = require('../settings/settings.js')
		var LOGGER = require('../server/log.js')
        var USER_HANDLER = require('../server/user-handler.js')

		// TODO: Make running local web server an option.
		//var WEBSERVER = require('../server/webserver.js')
		//var mWebServer = WEBSERVER.create()

        // ************** Login Button **********************

		// TODO: Move login to the connect tab.

		// Set login button action handler. The button
		// toggles login/logout.
		$('#button-login').click(function()
		{
            if (USER_HANDLER.getUser())
            {
                logoutUser()
            }
            else
            {
                loginUser()
            }
		})

		function loginUser()
		{
			USER_HANDLER.createLoginClient()
			USER_HANDLER.startLoginSequence()
			var loginURL = USER_HANDLER.getLoginURL()
			$('#connect-screen-login').show()
			$('#connect-screen-login-iframe').attr('src', loginURL)
		}

		function logoutUser()
		{
			USER_HANDLER.logoutUser()
		}

		EVENTS.subscribe(EVENTS.LOGIN, function(user)
		{
			// TODO: Pass user id to the Run/Reload messaging code (hyper-server.js) ??
			console.log('*** User has logged in: ' + user)
			console.dir(user)

			// Close login UI.
			$('#connect-screen-login').hide()

			if (user && user.name && user.picture)
			{
				// Display user data.
				if(user.picture.indexOf('http') == -1)
				{
					user.picture = user.EVO_SERVER + '/' + user.picture
				}
				// Show user picture on login button and change text to "Logout".
				var imageHTML =
					'<img style="height:30px;with:auto;margin-right:5px;margin-top:-3px" '
					+	'class="pull-left" '
					+	'src="' + user.picture + '">'
				var infoText = 'Logged in as '+user.name
				var infoHTML = imageHTML + infoText
				$('#login-info').html(infoHTML)

				// Change login button text to logout.
				$('#button-login').html('Logout')
            }
            else
            {
            	$('#login-info').html('Could not log in')
            }
		})

        EVENTS.subscribe(EVENTS.LOGOUT, function(user)
        {
            // TODO: Pass user id to the Run/Reload messaging code (hyper-server.js).
            LOGGER.log('*** User has logged out ***')
            // Set button text to "Login".
            $('#button-login').html('Login')
            $('#login-info').html('Not Logged In')
        })

		EVENTS.subscribe(EVENTS.DISCONNECT, function(obj)
		{
			logoutUser()
		})

		// ************** Tab Button Handling **************

		hyper.showTab = function(tabname)
		{
			// Hide all screens and set unselected colour for buttons.
			$('#screen-connect').hide()
			$('#screen-examples').hide()
			$('#screen-projects').hide()
			$('#button-connect, #button-examples, #button-projects')
				.removeClass('et-btn-stone')
				.addClass('et-btn-stone-light')

			// Show selected tab.
			var screenId = '#screen-' + tabname
			var buttonId = '#button-' + tabname
			$(screenId).show()
			$(buttonId).removeClass('et-btn-stone-light').addClass('et-btn-stone')
		}

		// ************** Connect Tab Button **************

		$('#button-connect').click(function()
		{
			hyper.showTab('connect')
		})

		// ************** Examples Tab Button **************


		$('#button-examples').click(function()
		{
			hyper.showTab('examples')
		})

		// ************** Projects Tab Button **************

		$('#button-projects').click(function()
		{
			hyper.showTab('projects')
		})

		// ************** Show Initial Tab **************

		hyper.showTab('connect')

		// ************** Tools Button **************

		$('#button-tools').click(function()
		{
			hyper.UI.showToolsWorkbenchWindow()
		})

		// ************** Documentation Button **************

		var button = $('#button-documentation')
		button && button.click(function()
		{
			var url = 'file://' + PATH.resolve('./documentation/index.html')
			GUI.Shell.openExternal(url)
		})

		// ************** Forum Button **************

		button = $('#button-forum')
		button && button.click(function()
		{
			GUI.Shell.openExternal('http://forum.evothings.com/')
		})

		// ************** Welcome Window **************

		// Reference to Welcome window, used for preventing opening it
		// multiple times and instead focusing it if already opened.
		var mWelcomeWindow = null

		hyper.showWelcomeScreen = function()
		{
			// Create window.
			mWelcomeWindow = window.open(
				'welcome.html',
				{
					resizable: true
				})
			mWelcomeWindow.resizeTo(550, 700)
			mWelcomeWindow.moveTo(50, 50)
			mWelcomeWindow.focus()
		}

		function getShowWelcomeScreen()
		{
			return 'no' != SETTINGS.getShowWelcomeScreen()
		}

		// Display welcome screen on startup if the display
		// setting is not turned off.
		if (getShowWelcomeScreen())
		{
			hyper.showWelcomeScreen()
		}

		// ************** No Client Connected Event **************

		// Called when you press Run and no client is connected.
		hyper.noClientConnectedHander = function()
		{
			$('#ModalDialog-NoClientConnected').modal('show')
		}

		// Click handler for link in the ModalDialog-NoClientConnected dialog.
		$('#ModalDialog-NoClientConnected-ClientAppLink').click(function()
		{
			var url = 'file://' + PATH.resolve('./documentation/studio/mobile-app.html')
			GUI.Shell.openExternal(url)
		})

		// ************** Version Check **************

		function versionCheck()
		{
			// Get currently installed version.
			var installedVersion = versionGetCurrent()

			// Get platform string.
			var platformTable =
			{
				'linux':'linux',
				'win32':'windows',
				'darwin':'macosx'
			}
			var platform = platformTable[process.platform]

			// Get saved GUID.
			var guid = SETTINGS.getEvoGUID()

			// Create JSON request data.
			var json =
				'{"platform":"' + platform + '",'
				+ '"version":"' + installedVersion + '"'
			if (guid) { json += ',"guid":"' + guid + '"' }
			json += '}'

			// Create URL for the request.
			var requestURL =
				'http://evothings.com/versioninfo/EvothingsWorkbench.php?param='
				+ encodeURIComponent(json)

			// TODO: For debugging, remove later on.
			LOGGER.log('Version request: ' + json)

			// Get version info from server.
			FILEUTIL.downloadAsString(
				requestURL,
				'EvothingsWorkbench', // User agent
				versionCheckResponseHandler)
		}

		function versionCheckResponseHandler(status, data)
		{
			// Abort if the response is not valid.
			if (200 != status)
			{
				console.log('Version response code: ' + status)
				return
			}

			// Parse response.
			var response
			try
			{
				console.log('Version response: ' + data)
				response = JSON.parse(data)
			}
			catch(e)
			{
				LOGGER.log("JSON.parse error: " + e)
				return
			}

			// Store GUID.
			SETTINGS.setEvoGUID(response.guid)

			// Get currently installed version.
			var installedVersion = versionGetCurrent()

			// Get value of version update user does not want to be reminded of.
			var doNotShowVersion = SETTINGS.getDoNotShowUpdateDialogForVersion()

			// Show dialog with info about new version.
			// Check that the available version is greater
			// than the installed version and that the user
			// has not marked this version as do-not-show.
			if (response.version > installedVersion &&
				response.version != doNotShowVersion)
			{
				hyper.newAvailableVersion = response.version

				$('#ModalDialog-NewVersionAvailable-VersionNumber').html(response.version)
				$('#ModalDialog-NewVersionAvailable').modal('show')
			}
		}

		function versionGetCurrent()
		{
			// Get installed version from package file.
			var data = FILEUTIL.readFileSync('package.json')
			var installedVersion = JSON.parse(data).version
			return installedVersion
		}

		// Click handler for download link in the ModalDialog-NewVersionAvailable dialog.
		$('#ModalDialog-NewVersionAvailable-DownloadLink').click(function()
		{
			GUI.Shell.openExternal('http://evothings.com/download/')
		})

		// Click handler for download link in the ModalDialog-NewVersionAvailable dialog.
		$('#ModalDialog-NewVersionAvailable-DoNotShowCheckbox').change(function(event)
		{
			// Store the version info that we should not show dialog for.
			var version = event.target.checked ? hyper.newAvailableVersion : null
			SETTINGS.setDoNotShowUpdateDialogForVersion(version)
		})

		window.showSettingsDialog = function()
		{
			hyper.UI.showSettingsDialog()
		}

		// Initialize the file server (socket.io client that
		// handles file requests).
		hyper.setUpServer()
        hyper.UI.connect()

		// Display the Connect dialog box.
		// TODO: Auto get key?
// 		setTimeout(window.showConnectKeyDialog, 100)

		// Do version check at start up.
		// VERSION CHECK DISABLED!
		// TODO: Enable in production.
		//setTimeout(versionCheck, 1000)
	})()
	</script>
</body>
</html>
